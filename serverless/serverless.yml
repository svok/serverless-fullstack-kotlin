service: ${opt:service}

plugins:
  - serverless-s3-sync
  - serverless-api-cloudfront

provider:
  name: aws
  runtime: java8
  stage: ${opt:stage}
  versionFunctions: false

package:
  artifact: ${opt:jar}

functions:
  hello:
    handler: com.serverless.Handler
    events:
      - http:
          path: api/hello
          method: get
custom:
  siteName: ${self:provider.stage}.${opt:domain}
  s3Sync:
    - bucketName: ${self:custom.siteName}-static
      localDir: build/web-static
      acl: public-read # optional
      followSymlinks: true # optional
      defaultContentType: text/html # optional
#      params: # optional
#        - index.html:
#            CacheControl: 'no-cache'
#        - "*.js":
#            CacheControl: 'public, max-age=31536000'

    - bucketName: ${self:custom.siteName}-spa
      bucketPrefix: spa/ # optional
      localDir: build/web-spa
      acl: public-read # optional
      followSymlinks: true # optional
      defaultContentType: text/html # optional
#      params: # optional
#        - index.html:
#            CacheControl: 'no-cache'
#        - "*.js":
#            CacheControl: 'public, max-age=31536000'

  apiCloudFront:
    domain: ${self:provider.stage}.${opt:domain}
    certificate: ${opt:domain-cert}
#    waf: 00000000-0000-0000-0000-000000000000
    compress: true
    logging:
      bucket: ${self:provider.stage}.${opt:domain}.logs.s3.amazonaws.com
      prefix: fullstack
    cookies: none
    headers:
      - x-api-key
    querystring:
      - page
      - per_page
    priceClass: PriceClass_100
    minimumProtocolVersion: TLSv1

resources:
  Resources:
    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.siteName}-static
        AccessControl: PublicRead
        WebsiteConfiguration:
          IndexDocument: index.html
          ErrorDocument: error.html

    OtherSiteBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.siteName}-spa
        AccessControl: PublicRead
        WebsiteConfiguration:
          IndexDocument: index.html
          ErrorDocument: index.html
